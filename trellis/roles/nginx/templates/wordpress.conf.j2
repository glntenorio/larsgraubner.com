# {{ ansible_managed }}

# don't send the nginx version number in error pages and Server header
server_tokens off;

# add security headers
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-Content-Type-Options nosniff always;
add_header X-XSS-Protection "1; mode=block" always;

include h5bp/location/expires.conf;

# rewrite sitemap urls
rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;
rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;
rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;
rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html.gz$ "/index.php?xml_sitemap=params=$2;html=true;zip=true" last;

# redirect feeds to feedburner
rewrite ^/feed/$ http://feeds.feedburner.com/larsgraubner/ permanent;

# Prevent PHP scripts from being executed inside the uploads folder.
location ~* /app/uploads/.*\.php$ {
  deny all;
}

location = /favicon.ico {
    root /srv/www/larsgraubner.com/current/web/app/themes/simius/assets/images/favicons;
}

location = /wp/xmlrpc.php {
  deny all;
  access_log off;
  log_not_found off;
}

# cache
location / {
  error_page 404 405 = @nocache;

  if ( $query_string ) {
    return 405;
  }

  if ( $request_method = POST ) {
    return 405;
  }

  if ( $request_uri ~ "/wp/" ) {
    return 405;
  }

  if ( $http_cookie ~ (wp-postpass|wordpress_logged_in|comment_author)_ ) {
    return 405;
  }

  default_type text/html;
  set $memcached_key $host$uri;
  memcached_pass localhost:11211;
}

# no cache
location @nocache {
  try_files $uri $uri/ /index.php?$args;
}

# Set the max body size equal to PHP's max POST size.
client_max_body_size {{ php_post_max_size | default('25m') | lower }};

include h5bp/directive-only/x-ua-compatible.conf;
include h5bp/directive-only/extra-security.conf;
include h5bp/location/cross-domain-fonts.conf;
include h5bp/location/protect-system-files.conf;
