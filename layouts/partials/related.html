{{ range first 1 (where (where .Site.Pages ".Params.categories" "intersect" .Params.categories) "Permalink" "!=" .Permalink) }}
  {{ $.Scratch.Set "has_related" true }}
{{ end }}

{{ if $.Scratch.Get "has_related" }}
  <div class="related">
    <div class="related__title">
      You might also like
    </div>
    <div class="post-list-small">
      <ul>
        {{ $num_to_show := .Site.Params.related_content_limit | default 5 }}
        {{ range first $num_to_show (where (where .Site.Pages ".Params.categories" "intersect" .Params.categories) "Permalink" "!=" .Permalink) }}
          <li>
            <a href="{{ .RelPermalink }}">
              <span class="date">
                {{ dateFormat "Jan 2, 2006" .Date }}
              </span>
              <span class="title">
                {{ .Title }}
              </span>
            </a>
          </li>
        {{ end }}
      </ul>
    </div>
  </div>
{{ end }}
